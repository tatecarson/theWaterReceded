<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for osc/Server.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../prettify.css">
    <link rel="stylesheet" href="../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">osc/Server.js</span></h1>
    <h2>
        Statements: <span class="metric">92.78% <small>(90 / 97)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">91.11% <small>(41 / 45)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(12 / 12)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">98.85% <small>(86 / 87)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../index.html">All files</a> &#187; <a href="index.html">osc/</a> &#187; Server.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">25</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-yes">9</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11</span>
<span class="cline-any cline-yes">11</span>
<span class="cline-any cline-yes">11</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">13</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">13</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">14</span>
<span class="cline-any cline-yes">12</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">33</span>
<span class="cline-any cline-yes">26</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">23</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">22</span>
<span class="cline-any cline-yes">16</span>
<span class="cline-any cline-yes">16</span>
<span class="cline-any cline-yes">16</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-yes">7</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">26</span>
<span class="cline-any cline-yes">20</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">/*
 * Copyright 2014-2016, Sébastien Piquemal &lt;sebpiq@gmail.com&gt;
 *
 * rhizome is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * rhizome is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with rhizome.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
"use strict";
&nbsp;
var _ = require('underscore')
  , async = require('async')
  , debug = require('debug')('rhizome.server.osc')
  , expect = require('chai').expect
  , coreMessages = require('../core/messages')
  , coreServer = require('../core/server')
  , coreValidation = require('../core/validation')
  , connections = require('../connections')
  , transport = require('./transport')
&nbsp;
&nbsp;
// Class to handle connections from OSC clients. 
var OSCConnection = function(args) {
  coreServer.Connection.call(this, args)
  this.ip = args[0]
  this.appPort = args[1]
  this.id = this.ip + ':' + this.appPort
  this.appClient = transport.createClient(this.ip, this.appPort, 'udp')
  this.appClient.on('error', (err) =&gt; <span class="cstat-no" title="statement not covered" >this.emit('error', err))</span>
}
&nbsp;
_.extend(OSCConnection.prototype, coreServer.Connection.prototype, {
  
  namespace: 'osc',
&nbsp;
  send: function(address, args) {
    if (this.blobClient &amp;&amp; args.some((arg) =&gt; arg instanceof Buffer)) {
      debug(this.toString() + ' sending to blob client ' + address + ' ' + coreMessages.argsToString(args))
      args = [this.appPort].concat(args)
      this.blobClient.send(address, args)
    } else this.appClient.send(address, args)
  },
&nbsp;
  onSysMessage: function(address, args) {
    // Change configuration of the client
    if (address === coreMessages.configureAddress) {
      var param = args[0]
&nbsp;
      <span class="missing-if-branch" title="else path not taken" >E</span>if (param === 'blobClient') {
        var blobsPort = args[1] || 44444
        this.setBlobClient(blobsPort)
        this.appClient.send(coreMessages.configuredAddress, [blobsPort])
        this.save()
      }
&nbsp;
    // Receives the request to send a blob, first checks the address,
    // and then asks the blob client to send the requested blob
    } else if (this.blobClient &amp;&amp; address === coreMessages.sendBlobAddress) {
      debug(this.toString() + ' asking blob client to send ' + coreMessages.argsToString(args))
      var originalAddress = args[0]
        , err = coreMessages.validateAddressForSend(originalAddress)
      if (err) this.appClient.send(coreMessages.errorAddress, [err])
      else this.blobClient.send(coreMessages.sendBlobAddress, args)
&nbsp;
    } else coreServer.Connection.prototype.onSysMessage.apply(this, arguments)
  },
&nbsp;
  setBlobClient: function(blobsPort) {
    this.infos.blobsPort = blobsPort
    this.blobClient = transport.createClient(this.ip, blobsPort, 'tcp')
    this.blobClient.on('error', (err) =&gt; {
      <span class="missing-if-branch" title="else path not taken" >E</span>if (err.code === 'ECONNREFUSED')
        this.emit('error', new Error('blob client refused connection'))
      else <span class="cstat-no" title="statement not covered" >this.emit('error', err)</span>
    })
    debug(this.toString() + ' configured blob client to port ' + blobsPort)
  },
&nbsp;
  // When deserializing the persisted connection, we need to restore blob client
  deserialize: function(data) {
    coreServer.Connection.prototype.deserialize.apply(this, arguments)
    if (this.infos.blobsPort) this.setBlobClient(this.infos.blobsPort)
  }
})
&nbsp;
&nbsp;
var OSCServer = module.exports = function(config) {
  coreServer.Server.call(this, config)
  this._server = null
  this._blobsServer = null
  this._config = config
}
&nbsp;
_.extend(OSCServer.prototype, coreValidation.ValidateConfigMixin, coreServer.Server.prototype, {
&nbsp;
  ConnectionClass: OSCConnection,
&nbsp;
  start: function(done) {
    this.validateConfig((err) =&gt; {
      if (err) return done(err)
      coreServer.Server.prototype.start.apply(this)
&nbsp;
      // This is the OSC server that receives normal messages
      this._server = transport.createServer(this._config.port, 'udp')
      this._server.on('message', this._onMessage.bind(this))
      this._server.on('error', (err) =&gt; <span class="cstat-no" title="statement not covered" >this.emit('error', err))</span>
&nbsp;
      // This is the server on which we receive the blobs sent by the blob client.
      // When an app client wants to send a blob, it sends a message to the server, which then asks the
      // blob client to actually send the blob. That way the user never deals directly with the blob client :
      //    APP                this._server                     BLOB-CLIENT                  this._blobsServer
      //    sendBlobAddress -&gt;
      //                    sendBlobAddress -&gt;
      //                                           /some/address &lt;blob&gt;, &lt;arg1&gt;, &lt;arg2&gt;, -&gt;
      this._blobsServer = transport.createServer(this._config.blobsPort, 'tcp')
      this._blobsServer.on('message', (address, args, rinfo) =&gt; <span class="cstat-no" title="statement not covered" >connections.manager.send(address, args))</span>
      this._blobsServer.on('error', (err) =&gt; <span class="cstat-no" title="statement not covered" >this.emit('error', err))</span>
&nbsp;
      async.waterfall([
        this._server.start.bind(this._server),
        this._blobsServer.start.bind(this._blobsServer),
        connections.manager.listPersisted.bind(connections.manager, OSCConnection.prototype.namespace),
&nbsp;
        // Immediately re-open OSC connections that were persisted. 
        // We need to do that because UDP OSC clients will not try to reconnect.
        (ids, next) =&gt; {
          async.each(ids, (id, nextId) =&gt; {
            var parts = id.split(':')
            this.openConnection([parts[0], parseInt(parts[1], 10)], nextId)
          }, next)
        }
      ], done)
    })
  },
&nbsp;
  stop: function(done) {
    if (this._server) {
      async.series([
        this._server.stop.bind(this._server),
        this._blobsServer.stop.bind(this._blobsServer),
        (next) =&gt; coreServer.Server.prototype.stop.call(this, next)
      ], (err) =&gt; {
        this._server.removeAllListeners()
        this._blobsServer &amp;&amp; this._blobsServer.removeAllListeners()
        this._server.on('error', () =&gt; {})
        this._blobsServer &amp;&amp; this._blobsServer.on('error', () =&gt; {})
        this._server = null
        this._blobsServer = null
        done(err)
      })
    } else done()
  },
&nbsp;
  configValidator: new coreValidation.ChaiValidator({
    blobsPort: function(val) {
      expect(val).to.be.a('number')
      expect(val).to.be.within(0, 65535)
    },
    port: function(val) {
      expect(val).to.be.a('number')
      expect(val).to.be.within(0, 65535)
    }
  }),
&nbsp;
  configDefaults: {
    blobsPort: 44445
  },
&nbsp;
  _onMessage: function (address, args, rinfo) {
    debug('message ' + address)
&nbsp;
    // System messages should always have the appPort as first argument.
    if (coreMessages.sysAddressRe.exec(address)) {
      var appPort = args[0]
        , args = args.slice(1)
        , ip = rinfo.address
        , connection = this._findConnection(ip, appPort)
&nbsp;
      // Quick port validation
      if (!_.isNumber(appPort) || appPort &lt;= 0 || appPort &gt;= 65536)
        return this.emit('error', new Error('Wrong sys message : "' + args + '" invalid port ' + appPort))
      // !!! We forbid to use the same port as rhizome server for osc clients. 
      // There is no problem when client is on a different machine, but if server and client
      // run on the same machine, the server will essentially send bogus messages to itself
      // and this will potentially lead to crashes that are hard to understand.
      if (appPort === this._config.port)
        return this.emit('error', new Error('Please keep port ' + appPort + ' reserved for the rhizome server'))
&nbsp;
      // If connection doesn't exist, create it, open it and sends the sys message
      // once connection is open
      if (!connection) {
        this.openConnection([ip, appPort], (err, connection) =&gt; {
          <span class="missing-if-branch" title="if path not taken" >I</span>if (err) <span class="cstat-no" title="statement not covered" >return this.emit('error', err)</span>
          connection.onSysMessage(address, args, rinfo)
        })
      } else connection.onSysMessage(address, args, rinfo)
&nbsp;
    // If normal message, we traverse the namespaces from / to `address` and send to all sockets
    } else {
      var err = coreMessages.validateAddressForSend(address)
      <span class="missing-if-branch" title="if path not taken" >I</span>if (err) <span class="cstat-no" title="statement not covered" >debug('invalid address : ' + address + '(' + err + ')')</span>
      else connections.manager.send(address, args)
    }
  },
&nbsp;
  // Debug function for OSCServer
  debug: debug,
&nbsp;
  _findConnection: function(ip, appPort) {
    return _.find(this.connections, (connection) =&gt; {
      return connection.ip === ip &amp;&amp; connection.appPort === appPort
    })
  }
&nbsp;
})</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Aug 22 2016 17:17:51 GMT+0200 (CEST)</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
